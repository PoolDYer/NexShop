@model OrdenDetailViewModel
@using NexShop.Web.ViewModels

@{
    ViewData["Title"] = $"Detalles de Orden - {Model.NumeroOrden}";
}

<link rel="stylesheet" href="@Url.Content("~/css/orden-detalles.css")" />

<div class="container-lg py-4">
    <!-- Encabezado -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="mb-0">
                <i class="bi bi-receipt"></i> Detalles de la Orden
            </h1>
            <p class="text-muted">Número de orden: <strong>@Model.NumeroOrden</strong></p>
        </div>
        <div class="col-auto">
            <a href="@Url.Action("MisOrdenes", "Ordenes")" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Volver a Mis Órdenes
            </a>
        </div>
    </div>

    <!-- Información Principal -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <!-- Estado de la Orden -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle"></i> Estado de la Orden
                        </h5>
                        @{
                            var estadoClass = Model.Estado == "Confirmada" ? "bg-success" :
                                              Model.Estado == "Pendiente" ? "bg-warning text-dark" :
                                              Model.Estado == "Cancelada" ? "bg-danger" : "bg-secondary";
                        }
                        <span class="badge @estadoClass">
                            @if (Model.Estado == "Confirmada")
                            {
                                <i class="bi bi-check-circle"></i> @Model.Estado
                            }
                            else if (Model.Estado == "Pendiente")
                            {
                                <i class="bi bi-hourglass-split"></i> @Model.Estado
                            }
                            else if (Model.Estado == "Cancelada")
                            {
                                <i class="bi bi-x-circle"></i> @Model.Estado
                            }
                            else
                            {
                                <i class="bi bi-info-circle"></i> @Model.Estado
                            }
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <small class="text-muted d-block mb-1">
                                <i class="bi bi-calendar"></i> Fecha de Orden
                            </small>
                            <strong>@Model.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</strong>
                        </div>
                        @if (Model.FechaConfirmacion.HasValue)
                        {
                            <div class="col-md-6 mb-3">
                                <small class="text-muted d-block mb-1">
                                    <i class="bi bi-check-circle"></i> Confirmada
                                </small>
                                <strong>@Model.FechaConfirmacion.Value.ToString("dd/MM/yyyy HH:mm")</strong>
                            </div>
                        }
                        @if (Model.FechaEnvio.HasValue)
                        {
                            <div class="col-md-6 mb-3">
                                <small class="text-muted d-block mb-1">
                                    <i class="bi bi-truck"></i> Enviada
                                </small>
                                <strong>@Model.FechaEnvio.Value.ToString("dd/MM/yyyy HH:mm")</strong>
                            </div>
                        }
                        @if (Model.FechaEntrega.HasValue)
                        {
                            <div class="col-md-6 mb-3">
                                <small class="text-muted d-block mb-1">
                                    <i class="bi bi-box2"></i> Entregada
                                </small>
                                <strong>@Model.FechaEntrega.Value.ToString("dd/MM/yyyy HH:mm")</strong>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Detalles de Productos -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bag"></i> Productos (@Model.TotalArticulos)
                    </h5>
                </div>
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th class="text-end">Precio Unitario</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var detalle in Model.Detalles)
                            {
                                <tr>
                                    <td>
                                        <i class="bi bi-box"></i> @detalle.ProductoNombre
                                    </td>
                                    <td class="text-end">
                                        $@detalle.PrecioUnitario.ToString("F2")
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-light text-dark">
                                            @detalle.Cantidad unidad@(detalle.Cantidad != 1 ? "es" : "")
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <strong>$@detalle.Subtotal.ToString("F2")</strong>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Dirección de Entrega -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-geo-alt"></i> Dirección de Entrega
                    </h5>
                </div>
                <div class="card-body">
                    <div class="border-start border-success ps-3">
                        <p class="mb-1">@Model.DireccionEntrega</p>
                        @if (!string.IsNullOrEmpty(Model.Notas))
                        {
                            <hr class="my-2" />
                            <small class="text-muted">
                                <strong>Notas adicionales:</strong> @Model.Notas
                            </small>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen de Pago (Sidebar) -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calculator"></i> Resumen de Pago
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Subtotal -->
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <strong>$@Model.Subtotal.ToString("F2")</strong>
                    </div>

                    <!-- Impuesto -->
                    @if (Model.Impuesto > 0)
                    {
                        <div class="d-flex justify-content-between mb-2 text-muted">
                            <span>Impuesto (16%):</span>
                            <span>$@Model.Impuesto.ToString("F2")</span>
                        </div>
                    }

                    <!-- Envío -->
                    @if (Model.MontoEnvio > 0)
                    {
                        <div class="d-flex justify-content-between mb-2 text-muted">
                            <span>Envío:</span>
                            <span>$@Model.MontoEnvio.ToString("F2")</span>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex justify-content-between mb-2 text-muted">
                            <span>Envío:</span>
                            <span class="badge bg-success">Gratis</span>
                        </div>
                    }

                    <!-- Descuento -->
                    @if (Model.Descuento > 0)
                    {
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>Descuento:</span>
                            <span>-$@Model.Descuento.ToString("F2")</span>
                        </div>
                    }

                    <!-- Separador -->
                    <hr class="my-3" />

                    <!-- Total -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Total:</h6>
                        <h4 class="text-success mb-0">$@Model.MontoTotal.ToString("F2")</h4>
                    </div>

                    <!-- Método de Pago -->
                    <div class="bg-light p-3 rounded">
                        <small class="text-muted d-block mb-1">
                            <i class="bi bi-credit-card"></i> Método de Pago
                        </small>
                        <strong>@(Model.MetodoPago ?? "No especificado")</strong>
                    </div>
                </div>
            </div>

            <!-- Acciones -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        @if (Model.Estado == "Pendiente")
                        {
                            <form method="post" asp-action="Cancelar" asp-controller="Ordenes" 
                                  asp-route-id="@Model.OrdenId">
                                <button type="submit" class="btn btn-outline-danger w-100" 
                                        onclick="return confirm('¿Deseas cancelar esta orden? Esta acción no puede ser deshecha.')">
                                    <i class="bi bi-x-circle"></i> Cancelar Orden
                                </button>
                            </form>
                        }
                        <a href="@Url.Action("Index", "Productos")" class="btn btn-outline-primary">
                            <i class="bi bi-shop"></i> Continuar Comprando
                        </a>
                    </div>
                </div>
            </div>

            <!-- Estado Info Box -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    @if (Model.Estado == "Confirmada")
                    {
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-check-circle"></i>
                            <strong>Orden Confirmada</strong>
                            <p class="mb-0 small mt-2">Tu pago ha sido procesado exitosamente. Recibirás un correo de confirmación.</p>
                        </div>
                    }
                    else if (Model.Estado == "Pendiente")
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-hourglass-split"></i>
                            <strong>Orden Pendiente</strong>
                            <p class="mb-0 small mt-2">Tu orden está en espera de confirmación. Por favor, espera un momento.</p>
                        </div>
                    }
                    else if (Model.Estado == "Cancelada")
                    {
                        <div class="alert alert-danger mb-0">
                            <i class="bi bi-x-circle"></i>
                            <strong>Orden Cancelada</strong>
                            <p class="mb-0 small mt-2">Esta orden ha sido cancelada y el dinero ha sido reembolsado.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Seguimiento (Timeline) -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-clock-history"></i> Historial de Seguimiento
            </h5>
        </div>
        <div class="card-body">
            <div class="timeline">
                <!-- Creada -->
                <div class="timeline-item mb-4">
                    <div class="d-flex">
                        <div class="timeline-marker bg-info text-white">
                            <i class="bi bi-plus-circle-fill"></i>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="mb-1">Orden Creada</h6>
                            <small class="text-muted">@Model.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</small>
                        </div>
                    </div>
                </div>

                <!-- Confirmada -->
                <div class="timeline-item mb-4 @(Model.FechaConfirmacion.HasValue ? "" : "opacity-50")">
                    <div class="d-flex">
                        <div class="timeline-marker @(Model.FechaConfirmacion.HasValue ? "bg-success text-white" : "bg-light text-muted")">
                            <i class="bi @(Model.FechaConfirmacion.HasValue ? "bi-check-circle-fill" : "bi-circle")"></i>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="mb-1">Confirmada</h6>
                            @if (Model.FechaConfirmacion.HasValue)
                            {
                                <small class="text-muted">@Model.FechaConfirmacion.Value.ToString("dd/MM/yyyy HH:mm")</small>
                            }
                            else
                            {
                                <small class="text-muted">Pendiente</small>
                            }
                        </div>
                    </div>
                </div>

                <!-- Enviada -->
                <div class="timeline-item mb-4 @(Model.FechaEnvio.HasValue ? "" : "opacity-50")">
                    <div class="d-flex">
                        <div class="timeline-marker @(Model.FechaEnvio.HasValue ? "bg-warning text-white" : "bg-light text-muted")">
                            <i class="bi @(Model.FechaEnvio.HasValue ? "bi-truck" : "bi-circle")"></i>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="mb-1">En Tránsito</h6>
                            @if (Model.FechaEnvio.HasValue)
                            {
                                <small class="text-muted">@Model.FechaEnvio.Value.ToString("dd/MM/yyyy HH:mm")</small>
                            }
                            else
                            {
                                <small class="text-muted">Pendiente</small>
                            }
                        </div>
                    </div>
                </div>

                <!-- Entregada -->
                <div class="timeline-item @(Model.FechaEntrega.HasValue ? "" : "opacity-50")">
                    <div class="d-flex">
                        <div class="timeline-marker @(Model.FechaEntrega.HasValue ? "bg-success text-white" : "bg-light text-muted")">
                            <i class="bi @(Model.FechaEntrega.HasValue ? "bi-box2-check" : "bi-circle")"></i>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="mb-1">Entregada</h6>
                            @if (Model.FechaEntrega.HasValue)
                            {
                                <small class="text-muted">@Model.FechaEntrega.Value.ToString("dd/MM/yyyy HH:mm")</small>
                            }
                            else
                            {
                                <small class="text-muted">Pendiente</small>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@model PreguntaCreateViewModel
@using NexShop.Web.ViewModels

<div class="formulario-pregunta card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-chat-left-quote"></i> ¿Tienes una pregunta sobre este producto?
        </h5>
    </div>
    <div class="card-body">
        @if (User?.Identity?.IsAuthenticated == true)
        {
            <form id="formulario-pregunta-form" class="pregunta-form-submit" data-producto-id="@Model.ProductoId">
                <div class="mb-3">
                    <label for="titulo" class="form-label fw-bold">Tu Pregunta *</label>
                    <input type="text" class="form-control" id="titulo" name="titulo" 
                           placeholder="Ej: ¿Este producto incluye garantía?" required>
                    <small class="text-muted d-block mt-1">
                        <i class="bi bi-info-circle"></i> 
                        Sé específico y claro. Máximo 500 caracteres.
                    </small>
                </div>

                <div class="mb-3">
                    <label for="descripcion" class="form-label">Detalles adicionales (opcional)</label>
                    <textarea class="form-control" id="descripcion" name="descripcion" 
                              placeholder="Proporciona más contexto si es necesario..." rows="3"></textarea>
                    <small class="text-muted d-block mt-1">
                        Máximo 2000 caracteres.
                    </small>
                </div>

                <input type="hidden" name="productoId" value="@Model.ProductoId" />

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> Publicar Pregunta
                    </button>
                    <button type="reset" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i> Limpiar
                    </button>
                </div>

                <div id="formulario-error" class="alert alert-danger mt-3" style="display: none;"></div>
                <div id="formulario-success" class="alert alert-success mt-3" style="display: none;"></div>
            </form>
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <p class="mb-0">
                    <a href="@Url.Page("/Account/Login", new { area = "Identity" })">Inicia sesión</a> 
                    para hacer preguntas sobre este producto.
                </p>
            </div>
        }
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('formulario-pregunta-form');
        
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const productoId = formData.get('productoId');
                const errorDiv = document.getElementById('formulario-error');
                const successDiv = document.getElementById('formulario-success');

                try {
                    const response = await fetch('/Preguntas/CrearPregunta', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        errorDiv.textContent = 'Error al publicar la pregunta';
                        errorDiv.style.display = 'block';
                        successDiv.style.display = 'none';
                        return;
                    }

                    const html = await response.text();
                    const container = document.getElementById('preguntas-container');
                    if (container) {
                        container.innerHTML = html;
                    }

                    // Limpiar formulario
                    this.reset();
                    successDiv.textContent = 'Pregunta publicada exitosamente';
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';

                    // Ocultar mensaje de éxito después de 3 segundos
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                    }, 3000);

                } catch (error) {
                    console.error('Error:', error);
                    errorDiv.textContent = 'Error de conexión';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                }
            });
        }
    });
</script>
